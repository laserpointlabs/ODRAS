name: Quick Smoke Tests

on:
    workflow_dispatch:
    # Run after successful deployment
    workflow_run:
        workflows: ["ODRAS Complete System CI"]
        types:
            - completed

jobs:
    smoke-test:
        name: Quick Validation Tests
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"

            - name: Install minimal dependencies
              run: |
                  pip install requests pytest psycopg2-binary qdrant-client

            - name: Run quick validation script
              run: |
                  python -c "
                  import sys
                  sys.path.insert(0, '.')
                  from tests.test_comprehensive_suite import run_quick_validation
                  run_quick_validation()
                  "

            - name: Test critical API test files
              run: |
                  # Check our actual API test files exist
                  test -f tests/api/test_core_functionality.py
                  test -f tests/api/test_complete_lifecycle.py
                  test -f tests/api/test_project_crud.py
                  test -f tests/api/test_auth_endpoints.py
                  test -f tests/api/README.md

                  echo "✓ All critical API test files present"

            - name: Validate project structure
              run: |
                  # Check critical files and directories for CURRENT structure
                  CRITICAL_PATHS=(
                    "odras.sh"
                    "requirements.txt"
                    "backend/main.py"
                    "backend/odras_schema.sql"
                    "backend/database_schema_info.json"
                    "tests/test_comprehensive_suite.py"
                    "tests/conftest.py"
                    "tests/api/"
                    ".github/workflows/ci.yml"
                    ".github/workflows/ci-simple.yml"
                  )

                  for path in "${CRITICAL_PATHS[@]}"; do
                    if [ -e "$path" ]; then
                      echo "✓ Found: $path"
                    else
                      echo "✗ Missing: $path"
                      exit 1
                    fi
                  done

                  echo ""
                  echo "✓ All critical project files verified"

            - name: Validate consolidated schema
              run: |
                  # Check that our consolidated schema file is substantial
                  if [ -s "backend/odras_schema.sql" ]; then
                    echo "✓ Consolidated schema file exists and has content"
                    echo "Schema file size: $(wc -c < backend/odras_schema.sql) bytes"
                  else
                    echo "✗ Consolidated schema file missing or empty"
                    exit 1
                  fi

            - name: Validate test structure
              run: |
                  # Check that our test structure is complete
                  if [ -d "tests/api" ] && [ $(ls tests/api/*.py | wc -l) -gt 20 ]; then
                    echo "✓ API test directory exists with comprehensive test files"
                    echo "API test files count: $(ls tests/api/*.py | wc -l)"
                  else
                    echo "✗ API test directory missing or incomplete"
                    exit 1
                  fi
