<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CQ/MT Workbench - ODRAS</title>
    <style>
        /* ODRAS Styling - Consistent with ontology-editor.html */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: system-ui, sans-serif;
            background: var(--bg, #0f172a);
            min-height: 100vh;
            padding: 0;
            color: var(--text, #e5e7eb);
            margin: 0;
        }

        .container {
            max-width: none;
            margin: 0;
            background: var(--bg, #0f172a);
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            min-height: 100vh;
        }

        .header {
            background: var(--panel, #111827);
            color: var(--text, #e5e7eb);
            padding: 20px;
            border-bottom: 1px solid var(--border, #1f2937);
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }

        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }

        .project-selector {
            margin: 20px 0 0 0;
        }

        .project-selector select {
            padding: 10px 15px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            min-width: 200px;
        }

        .project-selector select option {
            color: #333;
        }

        .tabs {
            display: flex;
            background: var(--panel-2, #0b1220);
            border-bottom: 1px solid var(--border, #1f2937);
        }

        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--muted, #9ca3af);
            transition: all 0.3s;
        }

        .tab:hover {
            background: var(--panel, #111827);
            color: var(--text, #e5e7eb);
        }

        .tab.active {
            background: var(--panel, #111827);
            color: var(--accent, #60a5fa);
            border-bottom: 2px solid var(--accent, #60a5fa);
        }

        .tab-content {
            display: none;
            padding: 20px;
            min-height: 500px;
            background: var(--bg, #0f172a);
        }

        .tab-content.active {
            display: block;
        }

        .btn {
            padding: 8px 16px;
            background: var(--accent, #60a5fa);
            color: var(--bg, #0f172a);
            border: 1px solid var(--border, #1f2937);
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            margin: 4px;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 11px;
            margin: 2px;
        }

        .btn:hover {
            background: var(--accent, #60a5fa);
            opacity: 0.9;
            transform: none;
        }

        .btn-success {
            background: var(--ok, #10b981);
            color: white;
        }

        .btn-success:hover {
            background: var(--ok, #10b981);
            opacity: 0.9;
        }

        .btn-warning {
            background: var(--warn, #f59e0b);
            color: white;
        }

        .btn-warning:hover {
            background: var(--warn, #f59e0b);
            opacity: 0.9;
        }

        .btn-danger {
            background: var(--err, #ef4444);
            color: white;
        }

        .btn-danger:hover {
            background: var(--err, #ef4444);
            opacity: 0.9;
        }

        .btn-secondary {
            background: var(--panel, #111827);
            color: var(--text, #e5e7eb);
        }

        .btn-secondary:hover {
            background: var(--panel-2, #0b1220);
        }

        /* Grid layouts */
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .three-column {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        /* Cards */
        .card {
            background: var(--panel, #111827);
            border: 1px solid var(--border, #1f2937);
            border-radius: 6px;
            padding: 16px;
            margin: 8px 0;
        }

        .card h3 {
            margin: 0 0 12px 0;
            color: var(--text, #e5e7eb);
            font-size: 1.2em;
            font-weight: 600;
        }

        /* Form elements */
        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border, #1f2937);
            border-radius: 4px;
            font-size: 13px;
            margin: 4px 0 12px 0;
            transition: border-color 0.2s;
            background: var(--panel-2, #0b1220);
            color: var(--text, #e5e7eb);
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--accent, #60a5fa);
            box-shadow: 0 0 3px rgba(96, 165, 250, 0.3);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        .sparql-editor {
            min-height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            background: #f8f9fa;
        }

        .contract-editor {
            min-height: 80px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        /* Lists */
        .item-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ecf0f1;
            border-radius: 5px;
        }

        .list-item {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .list-item:hover {
            background: #f8f9fa;
        }

        .list-item.selected {
            background: #ebf3fd;
            border-left: 4px solid #3498db;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .item-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .item-subtitle {
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
            margin-left: 10px;
        }

        .status-draft {
            background: #f39c12;
            color: white;
        }

        .status-active {
            background: #27ae60;
            color: white;
        }

        .status-deprecated {
            background: #95a5a6;
            color: white;
        }

        .run-status-pass {
            background: #27ae60;
            color: white;
        }

        .run-status-fail {
            background: #e74c3c;
            color: white;
        }

        /* Results display */
        .results-container {
            border: 1px solid #ecf0f1;
            border-radius: 5px;
            margin-top: 15px;
        }

        .results-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            font-weight: 600;
        }

        .results-content {
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .results-table th,
        .results-table td {
            padding: 8px 12px;
            border: 1px solid #ecf0f1;
            text-align: left;
        }

        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        /* Loading and status */
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .loading::after {
            content: "...";
            animation: dots 1s steps(5, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                color: rgba(0, 0, 0, 0);
                text-shadow: .25em 0 0 rgba(0, 0, 0, 0), .5em 0 0 rgba(0, 0, 0, 0);
            }

            40% {
                color: #7f8c8d;
                text-shadow: .25em 0 0 rgba(0, 0, 0, 0), .5em 0 0 rgba(0, 0, 0, 0);
            }

            60% {
                text-shadow: .25em 0 0 #7f8c8d, .5em 0 0 rgba(0, 0, 0, 0);
            }

            80%,
            100% {
                text-shadow: .25em 0 0 #7f8c8d, .5em 0 0 #7f8c8d;
            }
        }

        .error-message {
            background: #ffe6e6;
            color: #c0392b;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #e74c3c;
            margin: 15px 0;
        }

        .success-message {
            background: #e8f5e8;
            color: #27ae60;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #27ae60;
            margin: 15px 0;
        }

        .info-message {
            background: #ebf3fd;
            color: #2980b9;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
            margin: 15px 0;
        }

        /* Panel visibility */
        .panel {
            display: none;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .panel.visible {
            display: block;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: var(--panel, #111827);
            border-radius: 8px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border, #1f2937);
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--text, #e5e7eb);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-muted, #9ca3af);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .modal-close:hover {
            background: var(--panel-2, #0b1220);
            color: var(--text, #e5e7eb);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border, #1f2937);
        }

        /* Coverage stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #3498db;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            display: block;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* Deep link styling */
        .deep-link {
            display: inline-block;
            padding: 8px 15px;
            background: #9b59b6;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 0.9em;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        .deep-link:hover {
            background: #8e44ad;
        }

        /* Responsive design */
        @media (max-width: 768px) {

            .two-column,
            .three-column {
                grid-template-columns: 1fr;
            }

            .container {
                margin: 10px;
                border-radius: 8px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .tab-content {
                padding: 20px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>CQ/MT Workbench</h1>
            <p>Test-Driven Ontology Development: Define Competency Questions first, then build ontologies to satisfy
                them</p>
        </div>

        <!-- Ontology Selector for projects with multiple ontologies -->
        <div
            style="padding: 16px; background: var(--panel-2, #0b1220); border-bottom: 1px solid var(--border, #1f2937);">
            <label style="display: block; margin-bottom: 8px; color: var(--muted, #9ca3af); font-size: 13px;">
                Active Ontology Context:
            </label>
            <select id="ontology-selector" style="width: 300px; margin-bottom: 0;">
                <option value="">Loading ontologies...</option>
            </select>
            <span class="muted" style="margin-left: 12px; font-size: 12px;" id="ontology-import-info"></span>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('welcome')">Welcome</button>
            <button class="tab" onclick="showTab('cqs')">Competency Questions</button>
            <button class="tab" onclick="showTab('microtheories')">Microtheories</button>
            <button class="tab" onclick="showTab('coverage')">Coverage</button>
        </div>

        <!-- Welcome Tab -->
        <div id="welcome-tab" class="tab-content active">
            <div class="card">
                <h3>Test-Driven Ontology Development</h3>
                <p style="margin-bottom: 20px;">The CQ/MT Workbench enables a <strong>requirements-first
                        approach</strong> to building ontologies:</p>

                <div class="info-message">
                    <strong>Workflow:</strong><br>
                    1. <strong>Define Competency Questions</strong> → What must your ontology answer?<br>
                    2. <strong>Create Microtheory</strong> → Empty or minimal starting point<br>
                    3. <strong>Run CQs</strong> → See what fails (ontology gaps)<br>
                    4. <strong>Build Ontology</strong> → Add classes/properties to satisfy CQs<br>
                    5. <strong>Re-run CQs</strong> → Verify progress toward pass<br>
                    6. <strong>Iterate</strong> → Continue until all CQs pass
                </div>

                <h3>Benefits</h3>
                <ul style="margin: 15px 0; padding-left: 20px;">
                    <li><strong>Clear Requirements:</strong> CQs are executable specifications</li>
                    <li><strong>Objective Validation:</strong> Pass/fail, not subjective review</li>
                    <li><strong>Prevents Over-engineering:</strong> Build only what CQs require</li>
                    <li><strong>Living Documentation:</strong> CQs document ontology capabilities</li>
                    <li><strong>Change Impact:</strong> Re-run CQs to verify changes</li>
                </ul>

                <h3>Getting Started</h3>
                <ol style="margin: 15px 0; padding-left: 20px;">
                    <li><strong>Select a project</strong> from the dropdown above</li>
                    <li><strong>Go to Microtheories tab</strong> → Create a baseline microtheory</li>
                    <li><strong>Go to CQs tab</strong> → Define 5-10 competency questions</li>
                    <li><strong>Run your CQs</strong> → See what's missing</li>
                    <li><strong>Switch to Ontology Workbench</strong> → Build needed classes/properties</li>
                    <li><strong>Return here</strong> → Verify CQs now pass</li>
                </ol>
            </div>
        </div>

        <!-- Competency Questions Tab -->
        <div id="cqs-tab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Competency Questions</h3>
                <button class="btn btn-success" onclick="createNewCQ()">+ New CQ</button>
            </div>

            <div class="item-list" id="cq-list">
                <div class="loading">Loading competency questions</div>
            </div>

            <!-- CQ Run Panel (shown inline when CQ is selected) -->
            <div id="run-panel" class="panel" style="display: none; margin-top: 20px;">
                <h3>Run CQ: <span id="run-cq-name"></span></h3>

                <label>Microtheory:</label>
                <select id="run-mt">
                    <option value="">Use CQ default</option>
                </select>

                <label>Parameters (JSON):</label>
                <textarea id="run-params" placeholder='{"var1": "value1", "var2": "value2"}'></textarea>

                <div style="margin: 20px 0;">
                    <button class="btn btn-success" onclick="runCQ()">
                        <svg style="width:14px; height:14px; margin-right:4px;" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <polygon points="5,3 19,12 5,21" />
                        </svg>
                        Run CQ
                    </button>
                </div>

                <div id="run-results" style="margin-top: 20px;"></div>
                <div id="run-history" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- CQ Editor Modal -->
        <div id="cq-editor-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title" id="cq-editor-title">Create New CQ</h3>
                    <button class="modal-close" onclick="closeCQModal()">&times;</button>
                </div>

                <div class="modal-content">
                    <label>CQ Name:</label>
                    <input type="text" id="cq-name" placeholder="e.g., List all aircraft types">

                    <label>Problem Statement:</label>
                    <textarea id="problem-text"
                        placeholder="Describe what this competency question should answer in natural language..."></textarea>

                    <label>SPARQL Query:</label>
                    <textarea id="sparql-text" class="sparql-editor"
                        placeholder="SELECT ?aircraft ?type WHERE { ... }"></textarea>

                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn btn-secondary" onclick="suggestSPARQL()">
                            <svg style="width:14px; height:14px; margin-right:4px;" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3" />
                                <path
                                    d="M12 1v6M12 17v6M4.22 4.22l4.24 4.24M15.54 15.54l4.24 4.24M1 12h6M17 12h6M4.22 19.78l4.24-4.24M15.54 8.46l4.24-4.24" />
                            </svg>
                            Suggest SPARQL
                        </button>
                        <button class="btn btn-secondary" onclick="checkOntologyDeltas()">
                            <svg style="width:14px; height:14px; margin-right:4px;" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8" />
                                <path d="M21 21l-4.35-4.35" />
                            </svg>
                            Check Ontology
                        </button>
                    </div>

                    <label>Default Microtheory:</label>
                    <select id="mt-default">
                        <option value="">Use project default</option>
                    </select>

                    <label>Contract (JSON):</label>
                    <textarea id="contract-json" class="contract-editor"
                        placeholder='{"require_columns": ["aircraft", "type"], "min_rows": 1}'></textarea>

                    <label>Status:</label>
                    <select id="cq-status">
                        <option value="draft">Draft</option>
                        <option value="active">Active</option>
                        <option value="deprecated">Deprecated</option>
                    </select>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeCQModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveCQ()">Save CQ</button>
                </div>
            </div>
        </div>


        <!-- Microtheories Tab -->
        <div id="microtheories-tab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Microtheories</h3>
                <button class="btn btn-success" onclick="createNewMT()">+ New Microtheory</button>
            </div>

            <div class="item-list" id="mt-list">
                <div class="loading">Loading microtheories</div>
            </div>

            <!-- MT Creation Modal -->
            <div id="mt-modal"
                style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                <div
                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; width: 500px;">
                    <h3>Create New Microtheory</h3>

                    <label>Label:</label>
                    <input type="text" id="mt-label" placeholder="e.g., Baseline, Test Data, V1.0">

                    <label>Clone From (optional):</label>
                    <select id="mt-clone-from">
                        <option value="">Create empty</option>
                    </select>

                    <div style="margin: 15px 0;">
                        <label>
                            <input type="checkbox" id="mt-set-default"> Set as project default
                        </label>
                    </div>

                    <div style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="saveMT()">Create Microtheory</button>
                        <button class="btn btn-secondary" onclick="cancelMT()">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coverage Tab -->
        <div id="coverage-tab" class="tab-content">
            <h3>CQ Coverage Summary</h3>
            <p style="margin-bottom: 20px;">Overview of CQ pass/fail status across microtheories</p>

            <div id="coverage-stats" class="stats-grid">
                <div class="stat-card">
                    <span id="total-cqs" class="stat-number">-</span>
                    <div class="stat-label">Total CQs</div>
                </div>
                <div class="stat-card">
                    <span id="active-cqs" class="stat-number">-</span>
                    <div class="stat-label">Active CQs</div>
                </div>
                <div class="stat-card">
                    <span id="passing-cqs" class="stat-number">-</span>
                    <div class="stat-label">Recently Passing</div>
                </div>
                <div class="stat-card">
                    <span id="failing-cqs" class="stat-number">-</span>
                    <div class="stat-label">Recently Failing</div>
                </div>
            </div>

            <div id="coverage-details">
                <div class="loading">Loading coverage data</div>
            </div>
        </div>
    </div>

    <script>
        // =====================================
        // GLOBAL STATE
        // =====================================

        let currentProjectId = null;
        let currentOntologyIri = null;
        let selectedCQId = null;
        let currentCQs = [];
        let currentMTs = [];
        let projectOntologies = [];

        // =====================================
        // INITIALIZATION
        // =====================================

        async function init() {
            console.log('Initializing CQ/MT Workbench...');

            // Get project context from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            currentProjectId = urlParams.get('project_id') || urlParams.get('project');

            if (!currentProjectId) {
                showError('No project context available. Please access this workbench from within a project.');
                clearAllData();
                return;
            }

            console.log('Using project context:', currentProjectId);
            await loadOntologies();

            // Set up ontology selector change handler
            document.getElementById('ontology-selector').addEventListener('change', async function (e) {
                currentOntologyIri = e.target.value;
                console.log('Ontology context changed to:', currentOntologyIri);
                if (currentOntologyIri) {
                    await Promise.all([
                        loadMicrotheories(),
                        loadCQs(),
                        loadCoverage()
                    ]);
                } else {
                    clearCQMTData();
                }
            });
        }

        function clearAllData() {
            currentCQs = [];
            currentMTs = [];
            document.getElementById('cq-list').innerHTML = '<div class="loading">Select a project to view CQs</div>';
            document.getElementById('mt-list').innerHTML = '<div class="loading">Select a project to view Microtheories</div>';
            document.getElementById('coverage-details').innerHTML = '<div class="loading">Select a project to view coverage</div>';
            hidePanels();
        }

        // =====================================
        // PROJECT CONTEXT MANAGEMENT  
        // =====================================

        function getProjectContext() {
            return currentProjectId;
        }

        function updateProjectContext(projectId) {
            if (projectId && projectId !== currentProjectId) {
                currentProjectId = projectId;
                console.log('Project context updated:', projectId);
                // Reload data for new project
                Promise.all([
                    loadOntologies(),
                    loadMicrotheories(),
                    loadCQs(),
                    loadCoverage()
                ]);
            }
        }

        // =====================================
        // ONTOLOGY CONTEXT MANAGEMENT
        // =====================================

        async function loadOntologies() {
            if (!currentProjectId) return;

            try {
                // Get project ontologies from ODRAS API
                const response = await fetchAPI(`/api/ontology/?project=${currentProjectId}`);
                projectOntologies = response.data ? [response.data] : [];

                // Also load ontologies registry for this project
                try {
                    const registryResponse = await fetchAPI(`/api/projects/${currentProjectId}/ontologies`);
                    if (registryResponse.success && registryResponse.data) {
                        projectOntologies = registryResponse.data;
                    }
                } catch (e) {
                    console.log('Ontologies registry not available, using default');
                }

                populateOntologySelector();

            } catch (error) {
                console.error('Error loading ontologies:', error);
                projectOntologies = [];
                populateOntologySelector();
            }
        }

        function populateOntologySelector() {
            const selector = document.getElementById('ontology-selector');
            const infoSpan = document.getElementById('ontology-import-info');

            selector.innerHTML = '';

            if (projectOntologies.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No ontologies found - create one in Ontology Workbench';
                selector.appendChild(option);
                infoSpan.textContent = '';
                return;
            }

            if (projectOntologies.length === 1) {
                // Single ontology - auto-select it
                const ontology = projectOntologies[0];
                const option = document.createElement('option');
                option.value = ontology.graph_iri || ontology.iri;
                option.textContent = ontology.label || 'Main Ontology';
                option.selected = true;
                selector.appendChild(option);

                currentOntologyIri = ontology.graph_iri || ontology.iri;
                infoSpan.textContent = 'Auto-selected (single ontology)';

                // Auto-load data
                setTimeout(() => {
                    Promise.all([
                        loadMicrotheories(),
                        loadCQs(),
                        loadCoverage()
                    ]);
                }, 100);

            } else {
                // Multiple ontologies - let user choose
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select ontology to test...';
                selector.appendChild(defaultOption);

                projectOntologies.forEach(ontology => {
                    const option = document.createElement('option');
                    option.value = ontology.graph_iri || ontology.iri;
                    option.textContent = ontology.label || 'Unnamed Ontology';
                    selector.appendChild(option);
                });

                infoSpan.textContent = `${projectOntologies.length} ontologies available`;
            }
        }

        function clearCQMTData() {
            currentCQs = [];
            currentMTs = [];
            document.getElementById('cq-list').innerHTML = '<div class="muted" style="padding: 20px;">Select an ontology to view CQs</div>';
            document.getElementById('mt-list').innerHTML = '<div class="muted" style="padding: 20px;">Select an ontology to view Microtheories</div>';
            hidePanels();
        }

        // =====================================
        // MICROTHEORY MANAGEMENT
        // =====================================

        async function loadMicrotheories() {
            if (!currentProjectId) return;

            try {
                const response = await fetchAPI(`/api/cqmt/projects/${currentProjectId}/microtheories`);
                currentMTs = response || [];
                displayMicrotheories();
                populateMTSelectors();
            } catch (error) {
                console.error('Error loading microtheories:', error);
                document.getElementById('mt-list').innerHTML = '<div class="error-message">Error loading microtheories: ' + error.message + '</div>';
            }
        }

        function displayMicrotheories() {
            const container = document.getElementById('mt-list');

            if (currentMTs.length === 0) {
                container.innerHTML = '<div class="info-message">No microtheories found. Create your first microtheory to get started!</div>';
                return;
            }

            container.innerHTML = '';

            currentMTs.forEach(mt => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div class="item-title">
                        ${mt.label}
                        ${mt.is_default ? '<span class="status-badge run-status-pass">DEFAULT</span>' : ''}
                    </div>
                    <div class="item-subtitle">
                        ${mt.triple_count} triples • ${mt.iri}
                        ${mt.parent_iri ? '• Cloned from ' + mt.parent_iri : ''}
                    </div>
                    <div style="margin-top: 10px;">
                        ${!mt.is_default ? `<button class="btn btn-secondary" onclick="setDefaultMT('${mt.id}')">Set Default</button>` : ''}
                        <button class="btn btn-warning" onclick="cloneMT('${mt.iri}', '${mt.label}')">Clone</button>
                        <button class="btn btn-danger" onclick="deleteMT('${mt.id}', '${mt.label}')">Delete</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function populateMTSelectors() {
            const selectors = ['mt-default', 'run-mt', 'mt-clone-from'];

            selectors.forEach(selectorId => {
                const select = document.getElementById(selectorId);
                if (select) {
                    // Preserve first option
                    const firstOption = select.options[0];
                    select.innerHTML = '';
                    if (firstOption) select.appendChild(firstOption);

                    currentMTs.forEach(mt => {
                        const option = document.createElement('option');
                        option.value = mt.iri;
                        option.textContent = `${mt.label} (${mt.triple_count} triples)`;
                        select.appendChild(option);
                    });
                }
            });
        }

        function createNewMT() {
            document.getElementById('mt-modal').style.display = 'block';
            document.getElementById('mt-label').value = '';
            document.getElementById('mt-clone-from').value = '';
            document.getElementById('mt-set-default').checked = false;
        }

        function cancelMT() {
            document.getElementById('mt-modal').style.display = 'none';
        }

        async function saveMT() {
            const label = document.getElementById('mt-label').value.trim();
            if (!label) {
                showError('Please enter a microtheory label');
                return;
            }

            const data = {
                label: label,
                cloneFrom: document.getElementById('mt-clone-from').value || null,
                setDefault: document.getElementById('mt-set-default').checked
            };

            try {
                const response = await fetchAPI(`/api/cqmt/projects/${currentProjectId}/microtheories`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                if (response.success) {
                    showSuccess('Microtheory created successfully');
                    cancelMT();
                    await loadMicrotheories();
                } else {
                    showError('Failed to create microtheory: ' + response.message);
                }
            } catch (error) {
                console.error('Error creating microtheory:', error);
                showError('Failed to create microtheory: ' + error.message);
            }
        }

        function cloneMT(sourceIRI, sourceLabel) {
            document.getElementById('mt-modal').style.display = 'block';
            document.getElementById('mt-label').value = sourceLabel + ' Copy';
            document.getElementById('mt-clone-from').value = sourceIRI;
            document.getElementById('mt-set-default').checked = false;
        }

        async function setDefaultMT(mtId) {
            try {
                const response = await fetchAPI(`/api/cqmt/microtheories/${mtId}/set-default?project_id=${currentProjectId}`, {
                    method: 'POST'
                });

                if (response.success) {
                    showSuccess('Default microtheory updated');
                    await loadMicrotheories();
                } else {
                    showError('Failed to set default microtheory');
                }
            } catch (error) {
                console.error('Error setting default microtheory:', error);
                showError('Failed to set default microtheory: ' + error.message);
            }
        }

        async function deleteMT(mtId, mtLabel) {
            if (!confirm(`Are you sure you want to delete the microtheory "${mtLabel}"? This will permanently remove all its triples.`)) {
                return;
            }

            try {
                const response = await fetchAPI(`/api/cqmt/microtheories/${mtId}`, {
                    method: 'DELETE'
                });

                if (response.success) {
                    showSuccess('Microtheory deleted successfully');
                    await loadMicrotheories();
                } else {
                    showError('Failed to delete microtheory');
                }
            } catch (error) {
                console.error('Error deleting microtheory:', error);
                showError('Failed to delete microtheory: ' + error.message);
            }
        }

        // =====================================
        // COMPETENCY QUESTION MANAGEMENT
        // =====================================

        async function loadCQs() {
            if (!currentProjectId) return;

            try {
                const response = await fetchAPI(`/api/cqmt/projects/${currentProjectId}/cqs`);
                currentCQs = response || [];
                displayCQs();
            } catch (error) {
                console.error('Error loading CQs:', error);
                document.getElementById('cq-list').innerHTML = '<div class="error-message">Error loading CQs: ' + error.message + '</div>';
            }
        }

        function displayCQs() {
            const container = document.getElementById('cq-list');

            if (currentCQs.length === 0) {
                container.innerHTML = '<div class="info-message">No competency questions found. Create your first CQ to get started!</div>';
                return;
            }

            container.innerHTML = '';

            currentCQs.forEach(cq => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.onclick = () => selectCQ(cq.id);

                const runStatusBadge = cq.last_run_status !== null ?
                    `<span class="status-badge ${cq.last_run_status ? 'run-status-pass' : 'run-status-fail'}">
                        ${cq.last_run_status ? 'PASS' : 'FAIL'}
                    </span>` : '';

                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div class="item-title">
                                ${cq.cq_name}
                                <span class="status-badge status-${cq.status}">${cq.status.toUpperCase()}</span>
                                ${runStatusBadge}
                            </div>
                            <div class="item-subtitle">
                                ${cq.problem_text.substring(0, 100)}${cq.problem_text.length > 100 ? '...' : ''}
                                ${cq.last_run_at ? `• Last run: ${new Date(cq.last_run_at).toLocaleString()}` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px; margin-left: 10px;">
                            <button class="btn btn-sm" onclick="event.stopPropagation(); editCQ('${cq.id}')" style="padding: 4px 8px; font-size: 11px;">
                                Edit
                            </button>
                            <button class="btn btn-sm" onclick="event.stopPropagation(); selectCQ('${cq.id}')" style="padding: 4px 8px; font-size: 11px;">
                                Run
                            </button>
                            <button class="btn btn-sm" onclick="event.stopPropagation(); deleteCQ('${cq.id}', '${cq.cq_name}')" style="padding: 4px 8px; font-size: 11px; background: var(--danger, #dc2626); color: white;">
                                Delete
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function selectCQ(cqId) {
            selectedCQId = cqId;

            // Update selection styling
            document.querySelectorAll('#cq-list .list-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.list-item').classList.add('selected');

            // Show run panel
            showRunPanel(cqId);
        }

        function createNewCQ() {
            selectedCQId = null;
            document.getElementById('cq-editor-title').textContent = 'Create New CQ';

            // Clear form
            document.getElementById('cq-name').value = '';
            document.getElementById('problem-text').value = '';
            document.getElementById('sparql-text').value = '';
            document.getElementById('mt-default').value = '';
            document.getElementById('contract-json').value = '{"require_columns": [], "min_rows": 1}';
            document.getElementById('cq-status').value = 'draft';

            // Show modal
            document.getElementById('cq-editor-modal').classList.add('visible');
        }

        async function editCQ(cqId) {
            try {
                const response = await fetchAPI(`/api/cqmt/cqs/${cqId}`);
                if (response.success) {
                    const cq = response.data;
                    selectedCQId = cqId;
                    document.getElementById('cq-editor-title').textContent = 'Edit CQ';

                    // Populate form
                    document.getElementById('cq-name').value = cq.cq_name || '';
                    document.getElementById('problem-text').value = cq.problem_text || '';
                    document.getElementById('sparql-text').value = cq.sparql_text || '';
                    document.getElementById('mt-default').value = cq.mt_iri_default || '';
                    document.getElementById('contract-json').value = JSON.stringify(cq.contract_json, null, 2);
                    document.getElementById('cq-status').value = cq.status || 'draft';

                    // Show modal
                    document.getElementById('cq-editor-modal').classList.add('visible');
                } else {
                    showError('Failed to load CQ: ' + response.message);
                }
            } catch (error) {
                console.error('Error loading CQ:', error);
                showError('Failed to load CQ: ' + error.message);
            }
        }

        async function deleteCQ(cqId, cqName) {
            if (!confirm(`Are you sure you want to delete the competency question "${cqName}"?\n\nThis will also delete all run history for this CQ.`)) {
                return;
            }

            try {
                const response = await fetchAPI(`/api/cqmt/cqs/${cqId}`, {
                    method: 'DELETE'
                });

                if (response.success) {
                    showSuccess('Competency question deleted successfully');
                    await loadCQs();
                    // Hide run panel if this CQ was selected
                    if (selectedCQId === cqId) {
                        document.getElementById('run-panel').style.display = 'none';
                        selectedCQId = null;
                    }
                } else {
                    showError('Failed to delete CQ: ' + response.message);
                }
            } catch (error) {
                console.error('Error deleting CQ:', error);
                showError('Failed to delete CQ: ' + error.message);
            }
        }

        async function saveCQ() {
            const cqName = document.getElementById('cq-name').value.trim();
            const problemText = document.getElementById('problem-text').value.trim();
            const sparqlText = document.getElementById('sparql-text').value.trim();
            const contractText = document.getElementById('contract-json').value.trim();

            if (!cqName || !problemText || !sparqlText || !contractText) {
                showError('Please fill in all required fields');
                return;
            }

            let contractJson;
            try {
                contractJson = JSON.parse(contractText);
            } catch (e) {
                showError('Invalid JSON in contract field');
                return;
            }

            const data = {
                cq_name: cqName,
                problem_text: problemText,
                sparql_text: sparqlText,
                mt_iri_default: document.getElementById('mt-default').value || null,
                contract_json: contractJson,
                status: document.getElementById('cq-status').value
            };

            try {
                let response;
                if (selectedCQId) {
                    // Update existing CQ
                    response = await fetchAPI(`/api/cqmt/cqs/${selectedCQId}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create new CQ
                    response = await fetchAPI(`/api/cqmt/projects/${currentProjectId}/cqs`, {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                }

                if (response.success) {
                    showSuccess(selectedCQId ? 'Competency question updated successfully' : 'Competency question created successfully');
                    await loadCQs();
                    closeCQModal();
                } else {
                    showError('Failed to save CQ: ' + response.message);
                }
            } catch (error) {
                console.error('Error saving CQ:', error);
                showError('Failed to save CQ: ' + error.message);
            }
        }

        function cancelCQEdit() {
            hidePanels();
        }

        function closeCQModal() {
            document.getElementById('cq-editor-modal').classList.remove('visible');
        }

        // Close modal when clicking outside of it
        document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('cq-editor-modal');
            if (modal) {
                modal.addEventListener('click', function (e) {
                    if (e.target === modal) {
                        closeCQModal();
                    }
                });
            }
        });

        async function showRunPanel(cqId) {
            try {
                const response = await fetchAPI(`/api/cqmt/cqs/${cqId}`);
                if (response.success) {
                    const cq = response.data;

                    document.getElementById('run-cq-name').textContent = cq.cq_name;
                    document.getElementById('run-params').value = JSON.stringify(cq.params_json || {}, null, 2);

                    // Set default MT if available
                    if (cq.mt_iri_default) {
                        document.getElementById('run-mt').value = cq.mt_iri_default;
                    }

                    // Display recent runs
                    displayRunHistory(cq.recent_runs || []);

                    document.getElementById('run-panel').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading CQ details:', error);
                showError('Failed to load CQ details: ' + error.message);
            }
        }

        async function runCQ() {
            if (!selectedCQId) return;

            const mtIri = document.getElementById('run-mt').value || null;
            let params;

            try {
                const paramsText = document.getElementById('run-params').value.trim();
                params = paramsText ? JSON.parse(paramsText) : {};
            } catch (e) {
                showError('Invalid JSON in parameters field');
                return;
            }

            const data = {
                mt_iri: mtIri,
                params: params
            };

            try {
                // Show loading
                document.getElementById('run-results').innerHTML = '<div class="loading">Running CQ</div>';

                const response = await fetchAPI(`/api/cqmt/cqs/${selectedCQId}/run`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                displayRunResults(response);

                // Refresh run history
                setTimeout(() => showRunPanel(selectedCQId), 1000);

            } catch (error) {
                console.error('Error running CQ:', error);
                document.getElementById('run-results').innerHTML = '<div class="error-message">Failed to run CQ: ' + error.message + '</div>';
            }
        }

        function displayRunResults(result) {
            const container = document.getElementById('run-results');

            const passFailBadge = result.passed
                ? '<span class="status-badge run-status-pass">PASS</span>'
                : '<span class="status-badge run-status-fail">FAIL</span>';

            let html = `
                <div class="results-container">
                    <div class="results-header">
                        Run Results ${passFailBadge} • ${result.row_count} rows • ${result.latency_ms}ms
                    </div>
                    <div class="results-content">
            `;

            if (!result.passed) {
                html += `<div class="error-message"><strong>Reason:</strong> ${result.reason}</div>`;
            }

            if (result.columns && result.columns.length > 0 && result.rows_preview && result.rows_preview.length > 0) {
                html += '<table class="results-table"><thead><tr>';
                result.columns.forEach(col => {
                    html += `<th>${col}</th>`;
                });
                html += '</tr></thead><tbody>';

                result.rows_preview.forEach(row => {
                    html += '<tr>';
                    row.forEach(cell => {
                        html += `<td>${cell || ''}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table>';

                if (result.row_count > result.rows_preview.length) {
                    html += `<div style="margin-top: 10px; font-style: italic; color: #7f8c8d;">Showing first ${result.rows_preview.length} of ${result.row_count} rows</div>`;
                }
            }

            html += '</div></div>';

            container.innerHTML = html;

            // Show ontology link if CQ failed
            if (!result.passed) {
                buildOntologyLink();
            }
        }

        function displayRunHistory(runs) {
            const container = document.getElementById('run-history-list');

            if (runs.length === 0) {
                container.innerHTML = '<div style="color: #7f8c8d; font-style: italic;">No previous runs</div>';
                return;
            }

            container.innerHTML = '';

            runs.forEach(run => {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 10px; border: 1px solid #ecf0f1; border-radius: 5px; margin: 5px 0; font-size: 0.9em;';

                const passFailBadge = run.pass
                    ? '<span class="status-badge run-status-pass">PASS</span>'
                    : '<span class="status-badge run-status-fail">FAIL</span>';

                div.innerHTML = `
                    <div>
                        ${passFailBadge}
                        ${run.row_count} rows • ${run.latency_ms}ms • ${new Date(run.created_at).toLocaleString()}
                    </div>
                    ${!run.pass ? `<div style="color: #e74c3c; margin-top: 5px;">${run.reason}</div>` : ''}
                `;

                container.appendChild(div);
            });
        }

        function buildOntologyLink() {
            // Extract IRIs from current CQ's SPARQL and build deep link
            const link = document.getElementById('ontology-link');
            link.href = `/ontology-editor.html?project=${currentProjectId}&focus=missing-terms`;
            link.style.display = 'inline-block';
        }

        // =====================================
        // DAS ASSIST FUNCTIONS
        // =====================================

        async function suggestSPARQL() {
            const problemText = document.getElementById('problem-text').value.trim();
            if (!problemText) {
                showError('Please enter a problem statement first');
                return;
            }

            try {
                const response = await fetchAPI('/api/cqmt/assist/suggest-sparql', {
                    method: 'POST',
                    body: JSON.stringify({ problem_text: problemText })
                });

                document.getElementById('sparql-text').value = response.sparql_draft;
                showSuccess('SPARQL suggestion generated. Please review and customize for your ontology.');
            } catch (error) {
                console.error('Error suggesting SPARQL:', error);
                showError('Failed to suggest SPARQL: ' + error.message);
            }
        }

        async function checkOntologyDeltas() {
            const sparqlText = document.getElementById('sparql-text').value.trim();
            if (!sparqlText) {
                showError('Please enter SPARQL query first');
                return;
            }

            try {
                const response = await fetchAPI('/api/cqmt/assist/suggest-ontology-deltas', {
                    method: 'POST',
                    body: JSON.stringify({
                        sparql_text: sparqlText,
                        project_id: currentProjectId
                    })
                });

                let message = 'Ontology analysis complete:\n';
                message += `• ${response.existing.length} terms exist in ontology\n`;
                message += `• ${response.missing.length} terms are missing`;

                if (response.missing.length > 0) {
                    message += '\n\nMissing terms:\n' + response.missing.join('\n');
                }

                alert(message);
            } catch (error) {
                console.error('Error checking ontology deltas:', error);
                showError('Failed to check ontology: ' + error.message);
            }
        }

        // =====================================
        // COVERAGE FUNCTIONS
        // =====================================

        async function loadCoverage() {
            if (!currentProjectId || currentCQs.length === 0) {
                document.getElementById('coverage-details').innerHTML = '<div class="info-message">No CQs available for coverage analysis</div>';
                return;
            }

            // Calculate basic statistics
            const totalCQs = currentCQs.length;
            const activeCQs = currentCQs.filter(cq => cq.status === 'active').length;
            const passingCQs = currentCQs.filter(cq => cq.last_run_status === true).length;
            const failingCQs = currentCQs.filter(cq => cq.last_run_status === false).length;

            document.getElementById('total-cqs').textContent = totalCQs;
            document.getElementById('active-cqs').textContent = activeCQs;
            document.getElementById('passing-cqs').textContent = passingCQs;
            document.getElementById('failing-cqs').textContent = failingCQs;

            // Display detailed coverage
            const container = document.getElementById('coverage-details');

            if (currentMTs.length === 0) {
                container.innerHTML = '<div class="info-message">No microtheories available for coverage analysis</div>';
                return;
            }

            let html = '<h4>Coverage by Microtheory</h4>';

            currentMTs.forEach(mt => {
                const relevantCQs = currentCQs.filter(cq =>
                    cq.mt_iri_default === mt.iri ||
                    (mt.is_default && !cq.mt_iri_default)
                );

                const mtPassing = relevantCQs.filter(cq => cq.last_run_status === true).length;
                const mtFailing = relevantCQs.filter(cq => cq.last_run_status === false).length;
                const coverage = relevantCQs.length > 0 ? Math.round((mtPassing / relevantCQs.length) * 100) : 0;

                html += `
                    <div class="card" style="margin: 10px 0;">
                        <h4>${mt.label} ${mt.is_default ? '(Default)' : ''}</h4>
                        <div style="margin: 10px 0;">
                            <strong>Coverage: ${coverage}%</strong> 
                            (${mtPassing} passing, ${mtFailing} failing, ${relevantCQs.length} total)
                        </div>
                        <div style="background: #ecf0f1; height: 10px; border-radius: 5px; overflow: hidden;">
                            <div style="width: ${coverage}%; height: 100%; background: ${coverage > 80 ? '#27ae60' : coverage > 50 ? '#f39c12' : '#e74c3c'};"></div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // =====================================
        // UI UTILITY FUNCTIONS
        // =====================================

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');

            // Activate selected tab
            event.target.classList.add('active');

            // Load content if needed
            if (tabName === 'cqs' && currentCQs.length === 0) {
                loadCQs();
            } else if (tabName === 'microtheories' && currentMTs.length === 0) {
                loadMicrotheories();
            } else if (tabName === 'coverage') {
                loadCoverage();
            }
        }

        function hidePanels() {
            document.querySelectorAll('.panel').forEach(panel => {
                panel.classList.remove('visible');
            });
            // Hide run panel
            const runPanel = document.getElementById('run-panel');
            if (runPanel) {
                runPanel.style.display = 'none';
            }
        }

        function showError(message) {
            // Create temporary error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '20px';
            errorDiv.style.right = '20px';
            errorDiv.style.zIndex = '1000';
            errorDiv.style.maxWidth = '400px';

            document.body.appendChild(errorDiv);

            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        function showSuccess(message) {
            // Create temporary success message
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            successDiv.style.position = 'fixed';
            successDiv.style.top = '20px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '1000';
            successDiv.style.maxWidth = '400px';

            document.body.appendChild(successDiv);

            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 3000);
        }

        // =====================================
        // API HELPER FUNCTIONS
        // =====================================

        async function fetchAPI(url, options = {}) {
            const defaultOptions = {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include' // Include cookies for session-based auth
            };

            // Try to get token from current window's localStorage first
            let token = localStorage.getItem('auth_token');

            // If not found and we're in an iframe, try parent window
            if (!token && window.parent && window.parent !== window) {
                try {
                    token = window.parent.localStorage.getItem('auth_token');
                } catch (e) {
                    console.log('Cannot access parent localStorage for auth token');
                }
            }

            // Add authorization header if we have a token
            if (token) {
                defaultOptions.headers['Authorization'] = `Bearer ${token}`;
            }

            const finalOptions = { ...defaultOptions, ...options };

            const response = await fetch(url, finalOptions);

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            return await response.json();
        }

        // =====================================
        // INITIALIZE ON LOAD
        // =====================================

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>
